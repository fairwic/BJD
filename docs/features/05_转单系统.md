# 05 转单系统

## 概述
转单是平台核心创新功能，允许用户将"制作中"的订单转让给他人，回收定金。

**优先级**：P0 (Core/MVP)

**包含页面**：
- `TransferLanding.jsx` - 转单落地页(接收端)

---

## 1. 转单落地页 (`TransferLanding.jsx`)

### 1.1 功能定位
买家通过输入转单码或扫码接收他人转让的订单。

### 1.2 页面结构
```
┌─────────────────────────────┐
│ [<]         接收转单         │
├─────────────────────────────┤
│  [图标] 输入转单码接单        │
├─────────────────────────────┤
│  ┌─────────────────────┐    │
│  │ A B C D 1 2 3 4     │    │
│  └─────────────────────┘    │
├─────────────────────────────┤
│  [确认接单]                  │
└─────────────────────────────┘
```

### 1.3 用户操作流程

| 步骤 | 用户操作 | 系统响应 |
|------|----------|----------|
| 1 | 输入8位转单码 | 实时自动转大写格式化 |
| 2 | 点击「确认接单」 | 调用API查询订单信息 |
| 3 | 查看订单摘要 | 展示商品图+标题+转让价格 |
| 4 | 点击「立即接单」 | 进入支付流程(支付金额=原定金) |
| 5 | 支付成功 | 原子交易完成 -> 订单归属变更 -> 跳转成功页 |

### 1.4 异常处理

| 异常 | 系统响应 |
|------|----------|
| 码已使用 | Toast"该转单码已失效" |
| 码过期(7天) | Toast"转单码已过期" |
| 已被他人接单 | Toast"手慢了，该订单已被截胡" |

### 1.5 业务规则

| 规则项 | 说明 |
|--------|------|
| 原子性交易 | 扣款+打款+移交必须在一个事务中 |
| 锁单机制 | 进入确认页时加5分钟互斥锁 |
| 地址重置 | 订单转移后收货地址置空，需重新选择 |
| 每日限额 | 每用户每日限转出/入各3单 |

---

## 后端逻辑要点

### 数据模型

```sql
-- 转单记录表
CREATE TABLE transfers (
    id ULID PRIMARY KEY,
    order_id ULID NOT NULL,
    from_user_id ULID NOT NULL,
    to_user_id ULID,
    transfer_code VARCHAR(8) UNIQUE NOT NULL,
    price DECIMAL(10,2) NOT NULL,
    status VARCHAR(20) DEFAULT 'pending', -- pending, completed, expired
    expired_at TIMESTAMPTZ NOT NULL,
    created_at TIMESTAMPTZ DEFAULT NOW()
);
```

### API 设计

| 接口 | 方法 | 说明 |
|------|------|------|
| `/api/v1/transfers` | POST | 生成转单码 |
| `/api/v1/transfers/{code}` | GET | 查询转单信息 |
| `/api/v1/transfers/{code}/accept` | POST | 接单(支付) |

### 注意事项

1. **原子性交易**：
   - 使用数据库事务：扣款+打款+移交
   - 任一步骤失败全额回滚

2. **锁单机制**：
   - 查询转单信息时加Redis分布式锁
   - Key: `transfer_lock:{order_id}`, TTL: 5分钟

3. **码生成规则**：
   - 8位大写字母+数字
   - 排除易混淆字符(0OIL1)
   - 唯一性校验

4. **频率限制**：
   - 每用户每日转出/入各3单
   - Redis计数器实现

5. **资金流转**：
   - 新买家支付 -> 平台账户
   - 平台账户 -> 原买家(扣手续费)
   - 使用支付渠道的分账API
