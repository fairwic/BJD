# 01 用户认证体系

## 概述
用户认证体系是平台的入口和信任基石，包含登录注册、密码找回、实名认证、账号安全和个人资料管理。

**优先级**：P0 (Core/MVP)

**包含页面**：
- `Login.jsx` - 登录注册
- `ForgotPassword.jsx` - 忘记密码
- `RealNameVerification.jsx` - 实名认证
- `AccountSecurity.jsx` - 账号安全
- `ProfileEdit.jsx` - 资料编辑

---

## 1. 登录注册 (`Login.jsx`)

### 1.1 功能定位
平台唯一入口，支持「验证码登录」和「密码登录」双模式，以及微信/QQ第三方授权登录。

### 1.2 页面结构
```
┌─────────────────────────────┐
│   [全屏BJD背景图 + 模糊]     │
│                             │
│   ┌───────────────────┐     │
│   │  Tab: 验证码 | 密码 │     │
│   ├───────────────────┤     │
│   │  手机号输入框       │     │
│   │  验证码/密码输入框  │     │
│   │  [获取验证码] 按钮  │     │
│   │  [登录] 按钮        │     │
│   ├───────────────────┤     │
│   │  第三方登录图标     │     │
│   │  协议勾选          │     │
│   └───────────────────┘     │
└─────────────────────────────┘
```

### 1.3 用户操作流程

#### 场景A：验证码登录（主流程）

| 步骤 | 用户操作 | 触发条件 | 系统响应 | 异常处理 |
|------|----------|----------|----------|----------|
| 1 | 打开App | 冷启动 | 展示全屏背景图(模糊缩放动效0.5s) -> 底部弹出半屏登录卡片(Spring动画) -> 输入框默认不聚焦 | - |
| 2 | 点击手机号输入框 | 点击 | 呼起数字键盘 -> 输入框边框变Rose-500 -> 光标闪烁 | - |
| 3 | 输入手机号 | 逐位输入 | 实时格式化为 `138 1234 5678`(每3-4位加空格) -> 输入满11位后「获取验证码」按钮由灰变黑(Opacity 100%) -> 输入框右侧出现「✕」清除图标 | 非法格式(如字母)：直接拦截无法输入 |
| 4 | 点击「获取验证码」 | 按钮可点 | 按钮文字变Loading图标(转圈0.3s) -> 调用`POST /api/sms/send` -> 成功后按钮变为`60s`灰色倒计时 -> 顶部弹出Toast"验证码已发送"(2s消失) | 频率限制：Toast"请60秒后再试" + 按钮恢复<br>接口失败：Toast"发送失败，请重试" |
| 5 | 输入验证码 | 点击验证码输入框 | 呼起数字键盘 -> 6个独立格子 -> 每输入一位高亮下一格 -> **满6位自动提交**(无需点击登录) | - |
| 6 | 自动登录 | 输入满6位 | 全屏半透明Loading蒙层 -> 调用`POST /api/auth/login` -> | 验证码错误：输入框Shake动画(左右摆动3次) -> 清空内容 -> 键盘不收起 -> Toast"验证码错误"<br>网络超时：Toast"网络异常，请检查连接" -> 保留手机号 |
| 7a | 登录成功(老用户) | API返回用户信息 | 登录卡片下沉消失动画 -> 跳转首页(淡入0.3s) | - |
| 7b | 登录成功(新用户) | API返回is_new=true | 跳转「完善资料页」(设置昵称头像) | - |

#### 场景B：密码登录

| 步骤 | 用户操作 | 系统响应 |
|------|----------|----------|
| 1 | 点击Tab「密码」 | Tab下划线滑动切换 -> 验证码输入框变为密码输入框(带眼睛图标) |
| 2 | 输入密码 | 默认密文显示(●●●) -> 点击眼睛图标切换明/密文 |
| 3 | 点击「登录」按钮 | 校验密码长度≥6位 -> 调用登录API |

#### 场景C：第三方登录

| 步骤 | 用户操作 | 系统响应 |
|------|----------|----------|
| 1 | 点击微信图标 | 唤起微信App授权页 |
| 2 | 微信授权成功 | 回调本App -> 自动登录/注册 -> 跳转首页 |

### 1.4 业务规则

| 规则项 | 详细说明 |
|--------|----------|
| 手机号格式 | 必须为中国大陆11位手机号，正则：`^1[3-9]\d{9}$` |
| 验证码规则 | 6位纯数字；有效期5分钟；单次使用后失效 |
| 发送频率限制 | 60秒/次；10次/天/IP；超限后返回429状态码 |
| 密码规则 | 最少6位，最多20位；支持字母、数字、特殊字符 |
| 自动注册 | 未注册手机号验证成功后自动创建账号，分配随机昵称"用户XXXXX" |
| 协议强制 | 必须勾选协议才能登录；未勾选点击登录->协议文字抖动并变红 |

### 1.5 UI/UX 细节

| 元素 | 视觉规格 |
|------|----------|
| 背景图 | 高斯模糊(blur-3xl) + scale缩放动画(1.0->1.05循环) |
| 登录卡片 | 白色/半透明(bg-white/80) + backdrop-blur + 圆角(rounded-2xl) |
| 输入框聚焦 | 边框Rose-500 + 呼吸光效(ring-rose-500/20) |
| 倒计时 | 灰色文字 + 每秒跳动数字 |
| Toast | 顶部居中 + 渐入渐出 + 2秒自动消失 |

---

## 2. 忘记密码 (`ForgotPassword.jsx`)

### 2.1 功能定位
通过手机验证码重置登录密码。

### 2.2 页面结构
```
┌─────────────────────────────┐
│ < 返回         忘记密码      │
├─────────────────────────────┤
│  步骤指示器 [1] - [2] - [3] │
├─────────────────────────────┤
│  Step 1: 输入手机号         │
│  Step 2: 输入验证码         │
│  Step 3: 设置新密码         │
├─────────────────────────────┤
│  [下一步 / 重置密码] 按钮    │
└─────────────────────────────┘
```

### 2.3 用户操作流程

| 步骤 | 用户操作 | 系统响应 | 校验规则 |
|------|----------|----------|----------|
| 1 | 输入手机号 | 格式化显示 -> 「下一步」按钮高亮 | 11位合法手机号 |
| 2 | 点击「下一步」 | 发送验证码 -> 进入Step2 | - |
| 3 | 输入验证码 | 校验通过 -> 进入Step3 | 6位数字 |
| 4 | 输入新密码 | 实时显示密码强度条 | ≥6位 |
| 5 | 确认新密码 | 校验两次输入一致 | 必须与上方一致 |
| 6 | 点击「重置密码」 | 调用API -> 成功Toast"密码已重置" -> 跳转登录页 | - |

### 2.4 业务规则

| 规则项 | 说明 |
|--------|------|
| 密码强度 | 弱(<8位纯数字) / 中(8-12位或含字母) / 强(>12位含特殊字符) |
| 重置限制 | 同一手机号24小时内最多重置3次 |

---

## 3. 实名认证 (`RealNameVerification.jsx`)

### 3.1 功能定位
身份证OCR识别 + 公安二要素校验，是团长开团和高额交易(>2000元)的前置条件。

### 3.2 页面结构
```
┌─────────────────────────────┐
│ < 返回         实名认证      │
├─────────────────────────────┤
│  [提示框] 认证说明           │
├─────────────────────────────┤
│  ┌─────────┐ ┌─────────┐   │
│  │ 人像面   │ │ 国徽面   │   │
│  │ (上传)   │ │ (上传)   │   │
│  └─────────┘ └─────────┘   │
├─────────────────────────────┤
│  姓名: [自动填充]           │
│  身份证号: [自动填充]       │
├─────────────────────────────┤
│  [提交认证] 按钮             │
└─────────────────────────────┘
```

### 3.3 用户操作流程

| 步骤 | 用户操作 | 触发 | 系统响应 | 异常处理 |
|------|----------|------|----------|----------|
| 1 | 触发认证入口 | 点击「发起团购」 | 检测`is_verified=false` -> 弹出Modal"身份认证提醒" | - |
| 2 | 点击「去认证」 | 弹窗按钮 | 跳转本页 | - |
| 3 | 上传人像面 | 点击上传区域 | 调用相机/相册 -> 上传图片 -> 显示"扫描中..."(光效动画) -> 调用OCR API | 图片模糊：Toast"照片不清晰，请重拍" |
| 4 | OCR回填 | 上传成功 | 自动填入「姓名」「身份证号」输入框 -> 允许手动修正 | OCR识别失败：提示手动输入 |
| 5 | 上传国徽面 | 点击上传区域 | 同上 | - |
| 6 | 点击「提交认证」 | 表单校验通过 | 按钮变灰"审核中..." -> 页面不可返回 -> 调用公安API校验 -> 1-2s后弹出Lottie动画(金盾+礼花) -> 自动返回上一页 -> 头像增加V标 | 姓名不匹配：红字提示"姓名与证件号不符"<br>已绑定：Toast"该身份证已认证其他账号" |

### 3.4 业务规则

| 规则项 | 说明 |
|--------|------|
| 二要素校验 | 调用第三方API(阿里云/腾讯云)校验姓名+身份证号 |
| 唯一性 | 一张身份证只能绑定一个平台账号 |
| 未成年限制 | 年龄<18岁：弹窗提示"需监护人同意" + 单笔交易限额500元 |
| 数据安全 | 身份证照片AES-256加密存储；后台无权限查看原图 |

### 3.5 UI/UX 细节

| 元素 | 规格 |
|------|------|
| 上传区域 | 虚线边框 + 相机图标 + "点击上传"文字 |
| 扫描动画 | 光带从上到下扫过证件图 |
| 成功动画 | 金色盾牌旋转 + 礼花粒子 + 持续2秒 |

---

## 4. 账号安全 (`AccountSecurity.jsx`)

### 4.1 功能定位
安全等级展示、修改密码、管理绑定、设备管理。

### 4.2 页面结构
```
┌─────────────────────────────┐
│ < 返回         账号安全      │
├─────────────────────────────┤
│  安全等级: [█████░░░] 中     │
├─────────────────────────────┤
│  > 修改登录密码              │
│  > 绑定手机号 138****8888    │
│  > 绑定邮箱   未绑定         │
│  > 登录设备管理              │
└─────────────────────────────┘
```

### 4.3 功能项交互

| 功能 | 用户操作 | 系统响应 |
|------|----------|----------|
| 安全等级 | 查看 | 红(低)=仅密码 / 橙(中)=密码+手机 / 绿(高)=全绑定+实名 |
| 修改密码 | 点击跳转 | 进入修改密码页 -> 验证旧密码 -> 设置新密码 |
| 绑定手机 | 点击跳转 | 进入验证页 -> 验证码校验 -> 绑定成功 |
| 设备管理 | 点击跳转 | 展示登录记录列表(IP/时间/设备名) -> 可踢出其他设备 |

---

## 5. 资料编辑 (`ProfileEdit.jsx`)

### 5.1 功能定位
修改头像、昵称、个性签名。

### 5.2 用户操作流程

| 字段 | 用户操作 | 系统响应 | 校验规则 |
|------|----------|----------|----------|
| 头像 | 点击头像区域 | 底部弹出ActionSheet"拍照/从相册选择" -> 选择后进入裁剪(正方形) -> 上传 -> 替换显示 | 图片≤5MB |
| 昵称 | 点击编辑 | 输入框聚焦 -> 实时字符计数 -> 失焦自动保存 | 2-20字；禁止敏感词 |
| 个性签名 | 点击编辑 | 多行输入框 -> 最多100字 | - |

### 5.3 业务规则

| 规则项 | 说明 |
|--------|------|
| 敏感词过滤 | 昵称包含敏感词时提示"包含违规内容" |
| 自动保存 | 失焦后500ms自动调用保存API，无需点击按钮 |
