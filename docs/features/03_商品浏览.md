# 03 商品浏览

## 概述
商品浏览是用户发现和探索商品的核心模块，包含首页流量分发、商品详情、团长主页、商家主页。

**优先级**：P0 (Core/MVP)

**包含页面**：
- `UserShop.jsx` - 首页/商城
- `ProductDetail.jsx` - 商品详情
- `LeaderProfile.jsx` - 团长主页
- `MerchantProfile.jsx` - 商家主页

---

## 1. 首页/商城 (`UserShop.jsx`)

### 1.1 功能定位
平台流量入口，采用双Tab模式（现货市集/开团广场），支持搜索和快捷标签筛选。

### 1.2 页面结构
```
┌─────────────────────────────┐
│  [搜索框]            [许愿] │
│  [🔥热门] [3分] [4分] ...   │
├─────────────────────────────┤
│  [现货市集]  |  [开团广场]   │
├─────────────────────────────┤
│  ┌─────┐ ┌─────┐ ┌─────┐   │
│  │商品1│ │商品2│ │商品3│   │
│  │ ¥XX │ │ ¥XX │ │ ¥XX │   │
│  └─────┘ └─────┘ └─────┘   │
│  (瀑布流布局)                │
└─────────────────────────────┘
```

### 1.3 用户操作流程

#### 场景A：Tab切换

| 步骤 | 用户操作 | 系统响应 |
|------|----------|----------|
| 1 | 点击「开团广场」Tab | 内容区域左滑切换(Transition 0.3s) -> 加载团购数据(骨架屏0.3s) -> 筛选栏变更为"进度/截团时间" |
| 2 | 点击「现货市集」Tab | 同上，反向 |

#### 场景B：搜索商品

| 步骤 | 用户操作 | 系统响应 |
|------|----------|----------|
| 1 | 点击搜索框 | 聚焦 -> 光标闪烁 |
| 2 | 输入关键词"龙魂" | 实时过滤(防抖300ms) |
| 3 | 回车/点击搜索 | 调用API -> 展示结果 -> 顶部显示"搜索结果: 龙魂 (15)" |
| 4 | 点击「×」清除 | 清空搜索词 -> 恢复默认推荐列表 |

#### 场景C：快捷标签

| 步骤 | 用户操作 | 系统响应 |
|------|----------|----------|
| 1 | 点击「🔥热门」标签 | 自动填入搜索词"热门" -> 执行搜索 |
| 2 | 点击其他标签 | 同上，替换搜索词 |

#### 场景D：下拉刷新

| 步骤 | 用户操作 | 系统响应 |
|------|----------|----------|
| 1 | 在列表顶部下拉 | 触发阈值>60px -> 显示品牌Logo动画(娃娃眨眼) |
| 2 | 松手 | 调用API刷新 -> 列表更新 -> Toast"推荐了N个新活动" |

#### 场景E：点击商品卡片

| 步骤 | 用户操作 | 系统响应 |
|------|----------|----------|
| 1 | 点击商品卡片 | 记录点击行为(用于推荐算法) -> 路由跳转ProductDetail(id) |

### 1.4 业务规则

| 规则项 | 详细说明 |
|--------|----------|
| 数据隔离 | 现货Tab：查询`type=SPOT`且`status=ACTIVE`<br>团购Tab：查询`status IN (COLLECTING, PRODUCTION)` |
| 排序逻辑 | 默认按"更新时间"降序；可切换"价格升/降序" |
| 缓存策略 | 首屏前10条Redis缓存，5分钟更新 |
| 分页加载 | 上拉加载更多，每页20条 |

### 1.5 UI/UX 细节

| 元素 | 规格 |
|------|------|
| 瀑布流 | Masonry布局，2列，间距12px |
| 商品卡片 | 白色圆角(12px) + 阴影(shadow-sm) |
| 价格 | 红色(rose-500) + 粗体(font-bold) |
| 标签 | 左上角黑色半透明Badge |

---

## 2. 商品详情 (`ProductDetail.jsx`)

### 2.1 功能定位
展示商品详细信息、SKU选择、阶梯解锁进度，是转化的关键页面。

### 2.2 页面结构
```
┌─────────────────────────────┐
│ [<] [分享] [收藏]    (悬浮) │
├─────────────────────────────┤
│  ┌─────────────────────┐    │
│  │  商品主图轮播        │    │
│  │  (aspect-square)     │    │
│  └─────────────────────┘    │
├─────────────────────────────┤
│  ¥1,500 起                   │
│  商品标题文字...             │
├─────────────────────────────┤
│  [团长卡片] 头像+昵称+信用   │
│  [进店逛逛]                  │
├─────────────────────────────┤
│  [阶梯解锁进度条] 382/500    │
│  100单✅ 300单✅ 500单🔒     │
├─────────────────────────────┤
│  商品详情描述...             │
├─────────────────────────────┤
│  SKU选择: 尺寸/肤色/妆面     │
├─────────────────────────────┤
│  信任徽章: 实名✅ 工期⏰ 售后🛍️│
├─────────────────────────────┤
│  [店铺]  |  [立即购买 ¥X]   │ (底部固定)
└─────────────────────────────┘
```

### 2.3 用户操作流程

#### 场景A：浏览页面

| 步骤 | 用户操作 | 系统响应 |
|------|----------|----------|
| 1 | 进入页面 | 加载数据 -> 主图轮播自动播放(3s/张) |
| 2 | 上滑浏览 | 顶部导航栏：透明 -> 白色不透明(渐变) -> 标题淡入"商品详情" |
| 3 | 左右滑动主图 | 切换图片 -> 底部指示器更新 |

#### 场景B：SKU选择

| 步骤 | 用户操作 | 系统响应 |
|------|----------|----------|
| 1 | 点击「立即购买」 | 底部弹出SKU面板(Spring弹簧动画) -> 展示规格组 |
| 2 | 点击「3分」(尺寸) | 按钮高亮(白底+玫瑰红边框+右上角✓) -> 动态过滤：若「3分+烧肌」无货，「烧肌」按钮置灰不可点 -> 价格区间更新 |
| 3 | 点击「白肌」(肤色) | 同上 -> 若所有必选项已选完：顶部缩略图切换为对应SKU图片 -> 价格固定为具体值 -> 底部按钮变为「确定支付 ¥250」 |
| 4 | 点击「确定支付」 | 收起面板 -> 跳转确认订单页 |

**异常处理**：
- 未选全规格点击购买：页面轻微震动(Haptic) -> 未选中区块红色边框闪烁 -> Toast"请选择尺寸"

#### 场景C：查看阶梯进度

| 步骤 | 用户操作 | 系统响应 |
|------|----------|----------|
| 1 | 点击进度条/里程碑图标 | 底部弹出浮层，展示详细阶梯表 |
| 2 | 查看详情 | 显示"满50人送眼珠，满100人全员减50元..." |
| 3 | 点击「邀请好友」 | 生成分享卡片 -> 调用系统分享 |

#### 场景D：收藏商品

| 步骤 | 用户操作 | 系统响应 |
|------|----------|----------|
| 1 | 点击右上角空心❤️ | 变为实心红色❤️ -> Toast"已收藏" -> 调用API |
| 2 | 再次点击 | 变回空心 -> Toast"取消收藏" |

### 2.4 业务规则

| 规则项 | 详细说明 |
|--------|----------|
| SKU库存联动 | 选择「3分」后实时计算「3分+各肤色」的库存，库存=0的肤色置灰 |
| 阶梯定价 | 根据当前销量X遍历阶梯规则，动态显示价格 |
| 定金膨胀 | 若配置"定金¥50抵¥100"，下单时总价扣减膨胀差额 |
| 现货vs团购 | 现货：显示"24h发货"；团购：显示"征集中X%"+阶梯进度 |

### 2.5 UI/UX 细节

| 元素 | 规格 |
|------|------|
| 主图 | 1:1正方形，支持手势缩放 |
| SKU面板 | 最高60%屏幕高度，可滚动 |
| 选中状态 | 白底+玫瑰红边框+右上角小✓ |
| 置灰状态 | 灰色虚线边框+文字灰色 |

---

## 3. 团长主页 (`LeaderProfile.jsx`)

### 3.1 功能定位
展示团长个人信息、信用评分、进行中和历史团购，建立用户信任。

### 3.2 页面结构
```
┌─────────────────────────────┐
│ [<]                         │
├─────────────────────────────┤
│  [大头像]                    │
│  昵称 [V认证]                │
│  信用极好 95分 | 1250粉丝    │
│  [+关注]                     │
├─────────────────────────────┤
│  个人简介文字...             │
├─────────────────────────────┤
│  [进行中] | [历史团购] | [评价]│
├─────────────────────────────┤
│  团购卡片列表...             │
└─────────────────────────────┘
```

### 3.3 用户操作流程

| 操作 | 系统响应 |
|------|----------|
| 点击「+关注」 | 按钮变为「已关注」(灰色) -> 调用API -> 关注列表增加该团长 |
| 点击团购卡片 | 跳转GroupBuyDetail |
| 点击头像 | 全屏预览大图 |

### 3.4 业务规则

| 规则项 | 说明 |
|--------|------|
| 信用等级 | S(≥95) / A(80-94) / B(60-79) / C(<60) |
| 保证金标识 | 已缴纳显示金盾图标+金额 |

---

## 4. 商家主页 (`MerchantProfile.jsx`)

### 4.1 功能定位
展示店铺信息、现货商品列表。

### 4.2 页面结构
```
┌─────────────────────────────┐
│  [店招封面图]                │
├─────────────────────────────┤
│  [头像] 店铺名称 [金牌商家]   │
│  ⭐4.9 | 已售1.2万 | 上海     │
├─────────────────────────────┤
│  [搜索框] 店内搜索           │
├─────────────────────────────┤
│  商品网格列表...             │
└─────────────────────────────┘
```

### 4.3 用户操作流程

| 操作 | 系统响应 |
|------|----------|
| 店内搜索 | 过滤该店铺内的商品 |
| 点击商品 | 跳转ProductDetail |
| 点击「收藏店铺」 | 加入收藏列表 |

---

## 后端逻辑要点

### 数据模型

```sql
-- 商品/团购通用表(简化)
CREATE TABLE products (
    id ULID PRIMARY KEY,
    type VARCHAR(20) NOT NULL, -- spot, group_buy
    title VARCHAR(200) NOT NULL,
    cover_image VARCHAR(500),
    price_min DECIMAL(10,2),
    price_max DECIMAL(10,2),
    status VARCHAR(20) DEFAULT 'active',
    view_count INT DEFAULT 0,
    sales_count INT DEFAULT 0,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- SKU表
CREATE TABLE skus (
    id ULID PRIMARY KEY,
    product_id ULID NOT NULL,
    name VARCHAR(100) NOT NULL,
    price DECIMAL(10,2) NOT NULL,
    stock INT DEFAULT -1,
    attributes JSONB -- {"尺寸":"3分","肤色":"白肌"}
);

-- 收藏表
CREATE TABLE favorites (
    user_id ULID,
    target_id ULID,
    target_type VARCHAR(20), -- product, shop, post
    created_at TIMESTAMPTZ DEFAULT NOW(),
    PRIMARY KEY (user_id, target_id, target_type)
);
```

### API 设计

| 接口 | 方法 | 说明 |
|------|------|------|
| `/api/v1/products` | GET | 商品列表(支持筛选/分页/排序) |
| `/api/v1/products/{id}` | GET | 商品详情 |
| `/api/v1/products/{id}/skus` | GET | SKU列表 |
| `/api/v1/favorites` | POST | 收藏/取消收藏 |
| `/api/v1/leaders/{id}` | GET | 团长主页 |
| `/api/v1/shops/{id}` | GET | 商家主页 |

### 注意事项

1. **SKU库存联动**：
   - 查询时动态计算各SKU组合的库存
   - 使用Redis缓存热门商品SKU矩阵

2. **搜索优化**：
   - 接入Elasticsearch做全文搜索
   - 支持拼音、同义词、品牌别名

3. **缓存策略**：
   - 首页数据Redis缓存，5分钟TTL
   - 商品详情页CDN缓存，结合版本号失效

4. **浏览计数**：
   - 使用Redis INCR计数
   - 每分钟批量同步到数据库

5. **推荐算法**：
   - 记录用户点击行为
   - 基于协同过滤推荐相似商品
