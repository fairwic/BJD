# 02 地址与支付设置

## 概述
管理用户的收货地址和支付方式绑定，是订单履约的基础配置模块。

**优先级**：P0 (Core/MVP)

**包含页面**：
- `AddressManagement.jsx` - 收货地址管理
- `PaymentSettings.jsx` - 支付设置

---

## 1. 收货地址管理 (`AddressManagement.jsx`)

### 1.1 功能定位
新增、编辑、删除收货地址，支持智能粘贴识别和默认地址设置。

### 1.2 页面结构
```
┌─────────────────────────────┐
│ < 返回       收货地址    [+] │
├─────────────────────────────┤
│  ┌─────────────────────┐    │
│  │ 张三  138****8888   │ ⭐ │
│  │ 北京市朝阳区建国路88号│    │
│  │ [编辑] [删除]       │    │
│  └─────────────────────┘    │
│  ┌─────────────────────┐    │
│  │ 李四  139****9999   │    │
│  │ 上海市浦东新区...    │    │
│  └─────────────────────┘    │
└─────────────────────────────┘
```

### 1.3 用户操作流程

#### 场景A：新增地址

| 步骤 | 用户操作 | 触发 | 系统响应 | 校验规则 |
|------|----------|------|----------|----------|
| 1 | 点击右上角「+」 | 点击 | 跳转地址编辑页(空表单) | - |
| 2 | 智能粘贴 | 粘贴整段文本到顶部输入框 | 点击「识别」按钮 -> 正则解析姓名/电话/省市区/详细地址 -> 自动填入下方表单 | 文本包含姓名+电话+地址 |
| 3 | 手动填写姓名 | 输入 | 实时输入 | 必填，2-20字 |
| 4 | 手动填写电话 | 输入 | 自动格式化(138 1234 5678) | 必填，11位手机号 |
| 5 | 选择省市区 | 点击输入框 | 底部弹出3级联动Picker(省->市->区) -> 滚动选择 -> 点击确认 | 必选 |
| 6 | 填写详细地址 | 输入 | 多行文本框 | 必填，5-100字 |
| 7 | 设为默认 | 勾选Switch | 自动取消原默认地址(互斥) -> 当前地址变为默认 | - |
| 8 | 点击「保存」 | 按钮 | 校验通过 -> 调用API -> 返回列表页 -> 新地址高亮闪烁一下 | 所有必填项校验 |

#### 场景B：编辑地址

| 步骤 | 用户操作 | 系统响应 |
|------|----------|----------|
| 1 | 点击地址卡片或「编辑」 | 跳转编辑页(预填原数据) |
| 2 | 修改字段 | 实时更新 |
| 3 | 保存 | 调用API -> 返回列表 |

#### 场景C：删除地址

| 步骤 | 用户操作 | 系统响应 |
|------|----------|----------|
| 1 | 点击「删除」或左滑 | 弹出确认弹窗"确定删除该地址？" |
| 2 | 点击「确定」 | 调用API -> 列表移除该项(动画) |

### 1.4 业务规则

| 规则项 | 详细说明 |
|--------|----------|
| 默认地址互斥 | 全局只能有一个默认地址；设置新默认时自动取消原默认 |
| 订单关联修改 | 订单发货前：修改地址后同步更新未发货订单<br>订单已发货后：锁定修改，提示联系物流 |
| 智能识别格式 | 支持：姓名+手机+地址、地址+姓名+手机 等多种组合 |
| 地址上限 | 每个用户最多保存20个地址 |

### 1.5 UI/UX 细节

| 元素 | 规格 |
|------|------|
| 默认标识 | 黄色⭐图标 |
| 左滑删除 | 红色背景 + 垃圾桶图标 |
| 新增高亮 | 绿色边框闪烁2次 |

---

## 2. 支付设置 (`PaymentSettings.jsx`)

### 2.1 功能定位
管理支付宝、微信支付、银行卡绑定，设置默认支付方式。

### 2.2 页面结构
```
┌─────────────────────────────┐
│ < 返回         支付设置      │
├─────────────────────────────┤
│  ┌─────────────────────┐    │
│  │ [支付宝] 138****8888 │ ⭐ │
│  │ [设为默认] [解绑]    │    │
│  └─────────────────────┘    │
│  ┌─────────────────────┐    │
│  │ [微信] 已绑定        │    │
│  └─────────────────────┘    │
│  ┌─────────────────────┐    │
│  │ [银行卡] 未绑定      │    │
│  │ [去绑定]             │    │
│  └─────────────────────┘    │
└─────────────────────────────┘
```

### 2.3 用户操作流程

#### 场景A：绑定支付宝

| 步骤 | 用户操作 | 系统响应 |
|------|----------|----------|
| 1 | 点击「去绑定」 | 唤起支付宝App授权页 |
| 2 | 支付宝内确认授权 | 回调本App -> 获取支付宝账号信息 -> 显示绑定成功 |

#### 场景B：解绑支付方式

| 步骤 | 用户操作 | 系统响应 |
|------|----------|----------|
| 1 | 点击「解绑」 | 弹窗二次确认"解绑后将无法使用该方式支付" |
| 2 | 确认 | 调用API -> 移除绑定 |

#### 场景C：设为默认

| 步骤 | 用户操作 | 系统响应 |
|------|----------|----------|
| 1 | 点击「设为默认」 | 原默认取消 -> 当前变为默认 -> 黄色⭐标识 |

### 2.4 业务规则

| 规则项 | 说明 |
|--------|------|
| 默认互斥 | 只能有一个默认支付方式 |
| 解绑限制 | 若只剩一种支付方式且有进行中订单，禁止解绑 |
| 银行卡绑定 | 需输入卡号 + 预留手机号 + 验证码 |

### 2.5 UI/UX 细节

| 元素 | 规格 |
|------|------|
| 支付宝图标 | 蓝色圆形 + 白色"支" |
| 微信图标 | 绿色圆形 + 白色微信Logo |
| 账号脱敏 | 显示前3后4，中间**** |

---

## 后端逻辑要点

### 数据模型

```sql
-- 收货地址表
CREATE TABLE addresses (
    id ULID PRIMARY KEY,
    user_id ULID NOT NULL,
    name VARCHAR(50) NOT NULL,
    phone VARCHAR(20) NOT NULL,
    province VARCHAR(50),
    city VARCHAR(50),
    district VARCHAR(50),
    detail VARCHAR(200) NOT NULL,
    is_default BOOLEAN DEFAULT FALSE,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- 支付方式表
CREATE TABLE payment_methods (
    id ULID PRIMARY KEY,
    user_id ULID NOT NULL,
    type VARCHAR(20) NOT NULL, -- alipay, wechat, bank
    account VARCHAR(100), -- 脱敏后的账号
    is_default BOOLEAN DEFAULT FALSE,
    created_at TIMESTAMPTZ DEFAULT NOW()
);
```

### API 设计

| 接口 | 方法 | 说明 |
|------|------|------|
| `/api/v1/addresses` | GET | 获取地址列表 |
| `/api/v1/addresses` | POST | 新增地址 |
| `/api/v1/addresses/{id}` | PUT | 更新地址 |
| `/api/v1/addresses/{id}` | DELETE | 删除地址 |
| `/api/v1/addresses/{id}/default` | PUT | 设为默认 |

### 注意事项

1. **默认地址互斥**：
   - 设置新默认时，事务内先取消原默认
   - `UPDATE addresses SET is_default=false WHERE user_id=? AND is_default=true`

2. **智能地址解析**：
   - 使用正则匹配姓名、电话、省市区
   - 可接入第三方地址解析API

3. **地址与订单关联**：
   - 下单时复制地址快照到订单表
   - 原地址修改不影响已下单订单

4. **支付绑定**：
   - OAuth授权流程获取用户支付账号
   - 账号信息脱敏后存储
