# 07 社交广场

## 概述
社交内容模块是平台核心增长引擎，用户发布动态、参与话题、互动交流，形成BJD垂直社区氛围。

**优先级**：P0 (Core/MVP) ⚠️ 第一期核心功能

**包含页面**：
- `CreatePost.jsx` - 发布动态
- `PostDetail.jsx` - 动态详情
- `PublicUserProfile.jsx` - 用户主页
- `MyFollowing.jsx` - 我的关注
- `MyLikes.jsx` - 我的喜欢
- `MyAlbum.jsx` - 我的相册

---

## 1. 发布动态 (`CreatePost.jsx`)

### 1.1 功能定位
用户分享娃圈日常的入口，支持图文/视频、话题标签、关联商品。

### 1.2 页面结构
```
┌─────────────────────────────┐
│ [取消]      发布动态   [发布]│
├─────────────────────────────┤
│  ┌─────────────────────┐    │
│  │  文本输入区域        │    │
│  │  支持Emoji          │    │
│  └─────────────────────┘    │
├─────────────────────────────┤
│  图片九宫格预览              │
│  [+] 添加图片/视频           │
├─────────────────────────────┤
│  # 添加话题                  │
│  [#BJD日常] [#龙魂] [+]      │
├─────────────────────────────┤
│  🛍️ 关联商品                 │
│  [商品卡片预览]              │
├─────────────────────────────┤
│  📍 添加位置                 │
└─────────────────────────────┘
```

### 1.3 用户操作流程

| 步骤 | 用户操作 | 系统响应 | 校验规则 |
|------|----------|----------|----------|
| 1 | 输入文字 | 实时字数统计(0/500) | 最多500字 |
| 2 | 点击"+"添加图片 | 相册多选 -> 九宫格排列 | 最多9张图或1个视频 |
| 3 | 长按图片 | 显示拖拽手柄 -> 可排序 | - |
| 4 | 点击"#添加话题" | 弹出话题选择面板 | - |
| 5 | 搜索或选择话题 | 插入话题标签到文本区 | - |
| 6 | 点击"关联商品" | 弹出商品搜索 -> 选中后显示小卡片 | 最多3个商品 |
| 7 | 点击"发布" | 校验内容非空 -> 乐观更新(立即跳回广场) -> 后台上传 | 图文至少有一项 |

### 1.4 话题功能（超话系统）

#### 1.4.1 话题类型

| 类型 | 说明 | 示例 |
|------|------|------|
| 官方话题 | 平台运营创建，固定推荐 | #BJD日常# #开箱分享# #妆面教程# |
| 品牌话题 | 与品牌关联，自动聚合 | #龙魂# #AS# #Volks# |
| 热门话题 | 算法推荐，48小时内热度TOP | #今日穿搭# #古风娃娃# |
| 用户话题 | 用户自创，需审核 | #我的小鹿# |

#### 1.4.2 话题选择面板

```
┌─────────────────────────────┐
│  [搜索话题]                  │
├─────────────────────────────┤
│  🔥 热门话题                 │
│  #BJD日常  #开箱分享  #古风  │
├─────────────────────────────┤
│  ⭐ 我关注的话题              │
│  #龙魂  #6分娃娃             │
├─────────────────────────────┤
│  📝 最近使用                 │
│  #小鹿日记  #娃衣推荐        │
├─────────────────────────────┤
│  [+ 创建新话题]              │
└─────────────────────────────┘
```

#### 1.4.3 话题交互规则

| 操作 | 响应 |
|------|------|
| 点击话题标签 | 插入到光标位置，格式 `#话题名#` |
| 点击"创建新话题" | 弹窗输入话题名 -> 提交审核 -> 审核通过后可用 |
| 在广场点击话题 | 跳转话题详情页(聚合该话题所有动态) |

---

## 2. 话题详情页（新增）

### 2.1 功能定位
类似微博超话，聚合某个话题下的所有动态，形成垂直内容社区。

### 2.2 页面结构
```
┌─────────────────────────────┐
│ [<]       #龙魂#      [关注]│
├─────────────────────────────┤
│  话题封面图                  │
│  📊 讨论 12.5万 | 阅读 89万  │
│  📝 话题简介文字...          │
├─────────────────────────────┤
│  [最新] [最热] [精华]        │
├─────────────────────────────┤
│  动态瀑布流列表...           │
├─────────────────────────────┤
│  [发布到此话题] (悬浮按钮)   │
└─────────────────────────────┘
```

### 2.3 用户操作流程

| 操作 | 响应 |
|------|------|
| 点击"关注" | 关注该话题 -> 首页推荐权重提升 -> 新动态推送通知 |
| 点击"发布到此话题" | 跳转CreatePost，自动携带该话题标签 |
| Tab切换 | 最新=按时间倒序 / 最热=按互动量 / 精华=运营精选 |

---

## 3. 动态详情 (`PostDetail.jsx`)

### 3.1 用户操作流程

| 步骤 | 用户操作 | 系统响应 |
|------|----------|----------|
| 1 | 点击❤️ | 变红+数字+1；播放心跳粒子动画；防抖0.5s提交API |
| 2 | 点击评论框 | 底部弹出输入框(吸底) -> 输入 -> 发送 -> 立即追加到列表 |
| 3 | 点击话题标签 | 跳转话题详情页 |
| 4 | 点击@用户 | 跳转用户主页 |
| 5 | 点击分享 | 生成卡片 -> 调用系统分享 |
| 6 | 长按图片 | 显示"保存图片"菜单 |

### 3.2 评论系统

| 功能 | 规则 |
|------|------|
| 评论层级 | 支持2级（评论+回复） |
| 回复@提及 | 回复评论时自动@原评论作者 |
| 评论排序 | 默认按热度，可切换时间 |
| 评论字数 | 最多200字 |

---

## 4. 用户主页 (`PublicUserProfile.jsx`)

### 4.1 页面结构
```
┌─────────────────────────────┐
│ [<]                   [...]  │
├─────────────────────────────┤
│  [大头像]                    │
│  昵称 [V认证]                │
│  个性签名...                 │
│  📍 上海 | 入坑3年           │
├─────────────────────────────┤
│  关注 128 | 粉丝 1.2万 | 获赞 5.6万│
├─────────────────────────────┤
│  [+关注] [私信]              │
├─────────────────────────────┤
│  [动态] [喜欢] [话题]        │
├─────────────────────────────┤
│  内容列表...                 │
└─────────────────────────────┘
```

### 4.2 用户操作

| 操作 | 响应 |
|------|------|
| 点击"关注" | 按钮变"已关注" -> 双向关注显示"互相关注" |
| 点击"私信" | 跳转聊天页 |
| 点击"话题"Tab | 显示该用户参与的话题列表 |

---

## 5. 我的关注/喜欢/相册

（保持原有功能）

---

## 后端逻辑要点

### 数据模型

```sql
-- 动态表
CREATE TABLE posts (
    id ULID PRIMARY KEY,
    user_id ULID NOT NULL,
    content TEXT,
    images JSONB,  -- ["url1", "url2"]
    video_url VARCHAR(500),
    location VARCHAR(200),
    like_count INT DEFAULT 0,
    comment_count INT DEFAULT 0,
    share_count INT DEFAULT 0,
    is_deleted BOOLEAN DEFAULT FALSE,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- 话题表
CREATE TABLE topics (
    id ULID PRIMARY KEY,
    name VARCHAR(50) UNIQUE NOT NULL,
    cover_image VARCHAR(500),
    description TEXT,
    type VARCHAR(20), -- official, brand, hot, user
    post_count INT DEFAULT 0,
    view_count INT DEFAULT 0,
    follower_count INT DEFAULT 0,
    status VARCHAR(20) DEFAULT 'active', -- pending, active, banned
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- 动态-话题关联表
CREATE TABLE post_topics (
    post_id ULID,
    topic_id ULID,
    PRIMARY KEY (post_id, topic_id)
);

-- 用户关注话题
CREATE TABLE user_topic_follows (
    user_id ULID,
    topic_id ULID,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    PRIMARY KEY (user_id, topic_id)
);
```

### API 设计

| 接口 | 方法 | 说明 |
|------|------|------|
| `/api/v1/posts` | POST | 发布动态 |
| `/api/v1/posts` | GET | 获取动态列表(分页) |
| `/api/v1/posts/{id}` | GET | 获取动态详情 |
| `/api/v1/posts/{id}/like` | POST | 点赞 |
| `/api/v1/posts/{id}/comments` | GET/POST | 评论列表/发表评论 |
| `/api/v1/topics` | GET | 获取话题列表(热门/推荐) |
| `/api/v1/topics/{id}` | GET | 获取话题详情 |
| `/api/v1/topics/{id}/posts` | GET | 获取话题下的动态 |
| `/api/v1/topics/{id}/follow` | POST | 关注话题 |

### 注意事项

1. **图片上传**：
   - 前端压缩后上传(Max 1080p, Quality 0.8)
   - 后端存储到OSS，返回CDN URL
   - 需要生成缩略图用于列表展示

2. **点赞防刷**：
   - Redis记录用户点赞状态，防止重复点赞
   - 计数器使用Redis INCR，定期同步到数据库

3. **话题审核**：
   - 用户创建话题需进入审核队列
   - 接入敏感词过滤API

4. **Feed流算法**：
   - 热门 = 点赞数*2 + 评论数*3 + 分享数*5
   - 关注用户 + 关注话题 加权推荐

5. **内容审核**：
   - 图片/文本接入内容安全API(阿里云/腾讯云)
   - 异步审核，命中违规后隐藏+通知用户
