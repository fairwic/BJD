# 06 团长/商家工作台

## 概述
团长和商家的后台管理模块，是平台B端核心功能，包含团购发布、订单处理、发货管理、现货管理。

**优先级**：P0 (Core/MVP)

**包含页面**：
- `CreateGroupBuy.jsx` - 发起团购
- `GroupBuyManagement.jsx` - 团购列表
- `GroupBuyDetail.jsx` - 团购详情管理
- `OrderManagement.jsx` - 订单管理台
- `ShippingManagement.jsx` - 发货管理
- `CreateSpotProduct.jsx` - 发布现货
- `SpotProductManagement.jsx` - 现货管理

---

## 1. 发起团购 (`CreateGroupBuy.jsx`)

### 1.1 功能定位
团长创建新团购的入口，支持Excel批量导入SKU规格。

### 1.2 页面结构
```
┌─────────────────────────────┐
│ [<]       发起团购    [发布] │
├─────────────────────────────┤
│  基本信息                    │
│  ├ 标题: [输入框]            │
│  ├ 封面图: [上传区域]        │
│  ├ 全款金额: [¥ 输入]        │
│  ├ 定金金额: [¥ 输入]        │
│  └ 截团时间: [日期选择器]    │
├─────────────────────────────┤
│  商品描述                    │
│  [富文本编辑器]              │
├─────────────────────────────┤
│  规格设置                    │
│  ┌─────────────────────┐    │
│  │ [导入Excel]  [手动添加] │  │
│  └─────────────────────┘    │
│  ┌─────────────────────┐    │
│  │ 规格名    价格   库存 │    │
│  │ 白肌      ¥1500  50  │    │
│  │ 烧肌      ¥1600  30  │    │
│  │ [+ 添加规格]         │    │
│  └─────────────────────┘    │
├─────────────────────────────┤
│  阶梯设置 (可选)             │
│  ├ 满50人成团               │
│  ├ 满100人解锁赠品眼珠       │
│  └ [+ 添加阶梯]              │
└─────────────────────────────┘
```

### 1.3 表单字段详细校验

| 字段 | 类型 | 必填 | 校验规则 | 错误提示 |
|------|------|------|----------|----------|
| 标题 | 文本 | ✓ | 3-50字 | "标题长度需在3-50字之间" |
| 封面图 | 图片 | ✓ | ≤5MB, JPG/PNG/WEBP | "请上传封面图" |
| 全款金额 | 金额 | ✓ | ≥1元, 最多2位小数 | "全款金额格式不正确" |
| 定金金额 | 金额 | ✓ | ≤全款50%, ≥1元 | "定金不能超过全款的50%" |
| 截团时间 | 日期 | ✓ | >当前时间+24h | "截团时间需至少在24小时后" |
| 描述 | 富文本 | ✗ | 最多5000字 | - |
| 规格 | 数组 | ✓ | ≥1条 | "请至少添加一个规格" |

### 1.4 Excel导入详细流程

| 步骤 | 用户操作 | 系统响应 |
|------|----------|----------|
| 1 | 点击"导入Excel" | 打开文件选择器 |
| 2 | 选择.xlsx文件 | 前端解析(使用xlsx库) |
| 3 | 解析中 | 显示"正在解析..." + 进度条 |
| 4a | 解析成功 | 显示预览表格 + Toast"成功导入N条规格" |
| 4b | 格式错误 | 红色提示"表格格式错误，需包含[名称][价格]列" |
| 5 | 预览确认 | 异常行高亮红色(如价格为负) |
| 6 | 可手动修正 | 点击某行可编辑 |

**Excel模板格式**：
| 名称/规格名称 | 价格/单价 | 库存(可选) |
|--------------|----------|-----------|
| 白肌         | 1500     | 50        |
| 烧肌         | 1600     | 30        |

### 1.5 发布确认流程

| 步骤 | 系统响应 |
|------|----------|
| 1 | 点击"发布" -> 全量表单校验 |
| 2 | 校验通过 -> 弹窗二次确认"确认发布？发布后定金金额不可修改" |
| 3 | 确认 -> 按钮变Loading -> 调用API |
| 4 | 成功 -> 跳转团购详情页 -> Toast"发布成功" |

---

## 2. 团购列表 (`GroupBuyManagement.jsx`)

### 2.1 页面结构
```
┌─────────────────────────────┐
│ [<]       我的团购    [开团] │
├─────────────────────────────┤
│  [全部] [进行中] [已结束]    │
├─────────────────────────────┤
│  ┌─────────────────────┐    │
│  │ [封面] 龙魂·鹿神     │    │
│  │ 状态: 征集中 45%     │    │
│  │ 订单: 25 | 营收: ¥7.5万│   │
│  │ [管理] [进度] [订单] │    │
│  └─────────────────────┘    │
└─────────────────────────────┘
```

### 2.2 用户操作

| 操作 | 响应 |
|------|------|
| 点击卡片 | 跳转GroupBuyDetail |
| 点击"开团" | 跳转CreateGroupBuy |
| Tab筛选 | 过滤对应状态的团购 |
| 下拉刷新 | 重新加载列表 |

---

## 3. 团购详情管理 (`GroupBuyDetail.jsx`)

### 3.1 页面结构
```
┌─────────────────────────────┐
│ [<]     龙魂·鹿神     [...]  │
├─────────────────────────────┤
│  [封面图]                    │
│  状态: 制作中 | 进度: 75%    │
│  开团时间: 2024-01-01        │
├─────────────────────────────┤
│  📊 数据看板                 │
│  ┌─────────┬─────────┐      │
│  │ 总订单   │ 总营收   │      │
│  │ 25单    │ ¥75,000 │      │
│  ├─────────┼─────────┤      │
│  │⚠️待审核 │⚠️待补款  │      │
│  │ 3单     │ 8单     │      │
│  └─────────┴─────────┘      │
├─────────────────────────────┤
│  🔄 生产进度                 │
│  [●──●──●──○──○──○]         │
│   原型 翻模 灌注 打磨 上妆 发货│
│   10/05 11/12 12/01         │
├─────────────────────────────┤
│  📦 SKU统计                  │
│  白肌: 12单 | 烧肌: 8单      │
├─────────────────────────────┤
│  🎛️ 进度控制                 │
│  [截团制作] [更新进度]       │
│  [完工通知] [全部完成]       │
└─────────────────────────────┘
```

### 3.2 进度控制按钮详细逻辑

| 按钮 | 触发条件 | 系统响应 | 后续影响 |
|------|----------|----------|----------|
| 截团并制作 | 状态=征集中 | 进度设为30% -> 状态变"制作中" -> 禁止新订单 | 锁定截团时间 |
| 更新进度 | 状态=制作中 | 弹窗选择进度(50%/80%) -> 更新进度 -> 通知买家 | 推送消息 |
| 完工/收尾款 | 进度≥80% | 进度设为100% -> 所有订单状态变"待补款" -> **批量发送补款通知** | 触发催款流程 |
| 全部完成 | 所有订单已发货 | 状态变"已结束" -> 结算团长收益 | 归档 |

### 3.3 生产进度时间线

| 阶段 | 状态 | 视觉效果 |
|------|------|----------|
| 已完成 | ✅ | 绿色实心圆 + 日期 + 照片缩略图 |
| 当前阶段 | 🔵 | 蓝色脉冲动画圆 + 进度条 |
| 未开始 | ⚪ | 灰色空心圆 |

### 3.4 上传工厂照片

| 步骤 | 操作 | 响应 |
|------|------|------|
| 1 | 点击某阶段 | 弹窗"上传生产照片" |
| 2 | 选择照片 | 上传OSS -> 绑定到该阶段 |
| 3 | 上传成功 | 时间线显示缩略图 -> 推送给买家 |

---

## 4. 订单管理台 (`OrderManagement.jsx`)

### 4.1 页面结构
```
┌─────────────────────────────┐
│ [<]       订单管理    [导出] │
├─────────────────────────────┤
│  [快捷入口] [我的团购] [发货] │
├─────────────────────────────┤
│  📊 今日数据                 │
│  待审核: 5 | 制作中: 18 | 待发货: 3│
│  营收: ¥12,500              │
├─────────────────────────────┤
│  [待审核] [制作中] [待发货] [全部]│
├─────────────────────────────┤
│  [搜索框: 订单号/买家/手机]   │
├─────────────────────────────┤
│  订单卡片列表...             │
│  ┌─────────────────────┐    │
│  │ [☐] O12345 张三      │    │
│  │ 龙魂·鹿神 白肌 x1    │    │
│  │ 定金: ¥500 ✅        │    │
│  │ [确认收款]           │    │
│  └─────────────────────┘    │
├─────────────────────────────┤
│  [全选] [批量审核] [批量xxx] │ (底部操作栏)
└─────────────────────────────┘
```

### 4.2 审核定金详细流程

| 步骤 | 用户操作 | 系统响应 |
|------|----------|----------|
| 1 | 勾选订单(或全选) | 底部操作栏显示"已选X单" |
| 2 | 点击"确认收款" | 弹窗确认"已收到这N笔定金？" |
| 3 | 确认 | 逐条处理 -> 状态变"制作中" -> 列表移除(动画) |
| 4 | 完成 | Toast"X笔订单已确认" |

### 4.3 批量操作

| 操作 | 适用状态 | 响应 |
|------|----------|------|
| 批量审核 | 待审核 | 确认后批量变"制作中" |
| 批量发货 | 待发货 | 上传运单号Excel -> 异步处理 |
| 批量导出 | 全部 | 生成Excel下载 |

### 4.4 导出Excel

| 字段 | 说明 |
|------|------|
| 订单号 | O12345 |
| 商品 | 龙魂·鹿神 |
| 规格 | 白肌 |
| 买家ID | U00001 |
| 状态 | 制作中 |
| 定金 | ¥500 |
| 尾款 | ¥2500 |
| 下单时间 | 2024-01-01 12:00:00 |
| 收件人 | 张三 |
| 电话 | 138****8888 |
| 地址 | 北京市朝阳区... |

---

## 5. 发货管理 (`ShippingManagement.jsx`)

### 5.1 页面结构
```
┌─────────────────────────────┐
│ [<]       发货管理           │
├─────────────────────────────┤
│  [待发货(12)] [已发货]       │
├─────────────────────────────┤
│  [搜索: 订单号/收件人/手机]   │
├─────────────────────────────┤
│  ┌─────────────────────┐    │
│  │ 订单号: O12345       │    │
│  │ 龙魂·鹿神 白肌 x1    │    │
│  ├─────────────────────┤    │
│  │ 收件人: 张三         │    │
│  │ 138****8888         │    │
│  │ 北京市朝阳区建国路88号│    │
│  │ [复制地址]           │    │
│  ├─────────────────────┤    │
│  │ [立即发货]           │    │
│  └─────────────────────┘    │
└─────────────────────────────┘
```

### 5.2 发货详细流程

| 步骤 | 用户操作 | 系统响应 |
|------|----------|----------|
| 1 | 点击"立即发货" | 弹窗"输入运单号" |
| 2 | 输入运单号 | 自动识别快递公司(根据单号前缀) |
| 3 | 确认 | 调用API -> 状态变"已发货" |
| 4 | 成功 | 列表移除该订单 -> Toast"已发货" -> **自动通知买家** |

### 5.3 复制地址

| 操作 | 响应 |
|------|------|
| 点击"复制地址" | 复制"张三 13800138000 北京市朝阳区建国路88号"到剪贴板 -> Toast"已复制" |

---

## 6. 发布现货 (`CreateSpotProduct.jsx`)

### 6.1 表单字段

| 字段 | 类型 | 必填 | 校验规则 |
|------|------|------|----------|
| 标题 | 文本 | ✓ | 3-100字 |
| 品牌 | 下拉 | ✓ | 从品牌库选择 |
| 分类 | 下拉 | ✓ | 整娃/娃衣/眼珠/假发/配件 |
| 主图 | 图片 | ✓ | 1张封面 |
| 详情图 | 图片 | ✗ | 最多9张，支持拖拽排序 |
| 描述 | 富文本 | ✗ | 最多5000字 |
| SKU | 数组 | ✓ | ≥1条，每条需有名称+价格+库存 |

### 6.2 SKU设置

| 字段 | 校验 |
|------|------|
| 名称 | 必填，1-50字 |
| 价格 | 必填，≥0.01元 |
| 库存 | 必填，≥0整数 |

---

## 7. 现货管理 (`SpotProductManagement.jsx`)

### 7.1 操作详解

| 操作 | 条件 | 响应 |
|------|------|------|
| 编辑 | 任何状态 | 跳转CreateSpotProduct(编辑模式) |
| 上架 | 状态=下架 | 商品可被搜索购买 |
| 下架 | 状态=上架 | 商品不可见，已下单的不受影响 |
| 删除 | 无关联订单 | 二次确认后软删除 |
| 调整库存 | 任何状态 | 弹窗输入新库存 -> 实时更新 |

---

## 后端逻辑要点

### 数据模型

```sql
-- 团购表
CREATE TABLE group_buys (
    id ULID PRIMARY KEY,
    leader_id ULID NOT NULL,
    title VARCHAR(100) NOT NULL,
    cover_image VARCHAR(500),
    description TEXT,
    full_price DECIMAL(10,2) NOT NULL,
    deposit DECIMAL(10,2) NOT NULL,
    deadline TIMESTAMPTZ NOT NULL,
    progress INT DEFAULT 0, -- 0-100
    status VARCHAR(20) DEFAULT 'collecting', -- collecting, production, completed
    order_count INT DEFAULT 0,
    total_revenue DECIMAL(12,2) DEFAULT 0,
    is_deleted BOOLEAN DEFAULT FALSE,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- 团购SKU表
CREATE TABLE group_buy_skus (
    id ULID PRIMARY KEY,
    group_buy_id ULID NOT NULL,
    name VARCHAR(100) NOT NULL,
    price DECIMAL(10,2) NOT NULL,
    stock INT DEFAULT -1, -- -1表示无限
    sold_count INT DEFAULT 0
);

-- 现货商品表
CREATE TABLE products (
    id ULID PRIMARY KEY,
    shop_id ULID NOT NULL,
    title VARCHAR(200) NOT NULL,
    brand_id ULID,
    category VARCHAR(50),
    cover_image VARCHAR(500),
    images JSONB,
    description TEXT,
    status VARCHAR(20) DEFAULT 'active', -- active, inactive, deleted
    sales_count INT DEFAULT 0,
    view_count INT DEFAULT 0,
    created_at TIMESTAMPTZ DEFAULT NOW()
);
```

### API 设计

| 接口 | 方法 | 说明 |
|------|------|------|
| `/api/v1/group-buys` | POST | 创建团购 |
| `/api/v1/group-buys` | GET | 团长的团购列表 |
| `/api/v1/group-buys/{id}` | GET | 团购详情 |
| `/api/v1/group-buys/{id}/progress` | PUT | 更新进度 |
| `/api/v1/group-buys/{id}/complete` | POST | 完工/触发尾款 |
| `/api/v1/orders` | GET | 订单列表(支持筛选) |
| `/api/v1/orders/batch-verify` | POST | 批量审核定金 |
| `/api/v1/orders/batch-ship` | POST | 批量发货 |
| `/api/v1/orders/export` | GET | 导出Excel |
| `/api/v1/products` | POST/PUT | 创建/更新现货 |
| `/api/v1/products/{id}/status` | PUT | 上架/下架 |

### 注意事项

1. **Excel解析**：
   - 前端使用`xlsx`库解析，后端不处理Excel
   - 表头智能匹配：支持"名称/规格名称"、"价格/单价"等变体

2. **截团时间校验**：
   - 定时任务检查截团时间
   - 到期自动锁定，禁止新订单
   - 预留15分钟支付窗口给进行中的订单

3. **库存扣减**：
   - 下单时预占库存(Redis DECR)
   - 支付成功后确认扣减
   - 支付超时后释放库存

4. **完工通知触发**：
   - 点击"完工"后进入消息队列
   - 异步批量发送(App推送+短信)
   - 记录通知状态用于后续催款

5. **批量发货**：
   - 上传Excel后异步处理
   - 使用Job队列逐条更新
   - 生成处理报告(成功N单/失败N单+原因)

6. **权限校验**：
   - 团长只能操作自己的团购/订单
   - 商家只能操作自己店铺的商品
   - 通过JWT中的`user_id`+`role`校验

7. **并发安全**：
   - 订单状态变更使用乐观锁(version字段)
   - 库存操作使用Redis原子命令
