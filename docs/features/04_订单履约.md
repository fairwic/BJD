# 04 订单履约

## 概述
订单履约是交易闭环的核心，包含合同签署、订单状态管理、历史记录查询。

**优先级**：P0 (Core/MVP)

**包含页面**：
- `ContractSigning.jsx` - 签署购买协议
- `OrderDetail.jsx` - 订单详情
- `MyGroupBuys.jsx` - 我的参团记录
- `MyContracts.jsx` - 我的合同

---

## 1. 签署购买协议 (`ContractSigning.jsx`)

### 1.1 功能定位
支付定金前强制签署电子购买协议，具有法律效力。

### 1.2 用户操作流程

| 步骤 | 用户操作 | 系统响应 |
|------|----------|----------|
| 1 | 滚动阅读合同 | 必须滚动到底部才能勾选 |
| 2 | 勾选"我已阅读" | 「前往签名」按钮高亮 |
| 3 | 点击「前往签名」 | 进入横屏签名板(Canvas) |
| 4 | 手写签名 | 实时绘制笔迹，笔画>3有效 |
| 5 | 点击「确认使用」 | 签名合成到落款处 |
| 6 | 点击「签署并支付」 | 记录时间戳+IP -> 跳转支付 |

### 1.3 合同核心条款
- **定金约定**：定金支付后不可退还（红色加粗）
- **尾款时效**：通知后30天内补款
- **售后标准**：定制商品不支持七天无理由

---

## 2. 订单详情 (`OrderDetail.jsx`)

### 2.1 订单状态机
```
待付定金 -> 待审核 -> 制作中 -> 待付尾款 -> 待发货 -> 已发货 -> 已完成
```

### 2.2 各状态交互

| 状态 | 显示 | 可用操作 |
|------|------|----------|
| UNPAID_DEPOSIT | 倒计时15分钟 | 「支付定金」 |
| PRODUCTION | TrustTimeline | 「生成转单码」 |
| WAIT_FINAL | 待付尾款 | 「支付尾款」 |
| SHIPPED | 已发货 | 「查看物流」「确认收货」 |

### 2.3 转单功能
点击「生成转单码」-> 确认 -> 生成8位大写码 -> 可复制/保存海报

---

## 3. 我的参团记录 (`MyGroupBuys.jsx`)

Tab筛选：全部 / 进行中 / 已完成

点击订单卡片 -> 跳转OrderDetail

---

## 4. 我的合同 (`MyContracts.jsx`)

列表展示已签合同，支持查看PDF和下载。

---

## 后端逻辑要点

### 数据模型

```sql
-- 订单表
CREATE TABLE orders (
    id ULID PRIMARY KEY,
    order_no VARCHAR(20) UNIQUE NOT NULL,
    user_id ULID NOT NULL,
    product_id ULID NOT NULL,
    sku_id ULID,
    deposit DECIMAL(10,2) NOT NULL,
    final_payment DECIMAL(10,2),
    total_amount DECIMAL(10,2) NOT NULL,
    status VARCHAR(30) DEFAULT 'unpaid_deposit',
    address_snapshot JSONB,
    contract_id ULID,
    transfer_code VARCHAR(8),
    transfer_status VARCHAR(20),
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- 合同表
CREATE TABLE contracts (
    id ULID PRIMARY KEY,
    order_id ULID NOT NULL,
    template_version VARCHAR(10),
    content TEXT,
    signature_image VARCHAR(500),
    signed_at TIMESTAMPTZ,
    signed_ip VARCHAR(50),
    contract_hash VARCHAR(64)
);
```

### API 设计

| 接口 | 方法 | 说明 |
|------|------|------|
| `/api/v1/orders` | POST | 创建订单 |
| `/api/v1/orders` | GET | 订单列表 |
| `/api/v1/orders/{id}` | GET | 订单详情 |
| `/api/v1/orders/{id}/pay-deposit` | POST | 支付定金 |
| `/api/v1/orders/{id}/pay-final` | POST | 支付尾款 |
| `/api/v1/contracts/{id}` | GET | 获取合同 |
| `/api/v1/contracts/{id}/sign` | POST | 签署合同 |

### 注意事项

1. **订单状态机**：
   - 使用状态模式严控流转
   - 禁止非法跳跃(如未付尾款直接发货)

2. **支付超时**：
   - 定金15分钟超时关闭
   - 使用延迟队列(Redis/RabbitMQ)

3. **合同安全**：
   - 生成后计算SHA-256哈希
   - 存储到OSS，禁止修改

4. **库存预占**：
   - 下单时Redis预占
   - 支付成功后确认扣减

5. **事务一致性**：
   - 订单创建+库存扣减在同一事务
   - 使用数据库事务或Saga模式
